# Neo4j Production Configuration for VAUCDA
# Optimized for 32GB RAM server with vector search capabilities

#*****************************************************************
# Memory Settings
#*****************************************************************

# Initial heap size (8GB for production)
dbms.memory.heap.initial_size=8g

# Maximum heap size (8GB for production)
dbms.memory.heap.max_size=8g

# Page cache for better query performance (16GB)
# Stores frequently accessed graph data in memory
dbms.memory.pagecache.size=16g

# Transaction state memory (2GB)
dbms.memory.transaction.global_max_size=2g
dbms.memory.transaction.database_max_size=1g

#*****************************************************************
# Network Connector Configuration
#*****************************************************************

# Bolt connector for Neo4j drivers
dbms.connector.bolt.enabled=true
dbms.connector.bolt.listen_address=0.0.0.0:7687
dbms.connector.bolt.advertised_address=:7687

# Bolt thread pool configuration (for 500+ concurrent users)
dbms.connector.bolt.thread_pool.min_size=50
dbms.connector.bolt.thread_pool.max_size=400
dbms.connector.bolt.thread_pool.keep_alive=5m

# HTTP connector for Neo4j Browser
dbms.connector.http.enabled=true
dbms.connector.http.listen_address=0.0.0.0:7474
dbms.connector.http.advertised_address=:7474

#*****************************************************************
# Security Configuration
#*****************************************************************

# Enable Bolt over TLS
dbms.ssl.policy.bolt.enabled=true
dbms.ssl.policy.bolt.base_directory=/var/lib/neo4j/certificates/bolt
dbms.ssl.policy.bolt.client_auth=NONE

# Enable HTTPS for browser
dbms.ssl.policy.https.enabled=true
dbms.ssl.policy.https.base_directory=/var/lib/neo4j/certificates/https
dbms.ssl.policy.https.client_auth=NONE

# Authentication settings
dbms.security.auth_enabled=true

# Unrestricted procedures for APOC and GDS
dbms.security.procedures.unrestricted=apoc.*,gds.*
dbms.security.procedures.allowlist=apoc.*,gds.*

#*****************************************************************
# Transaction Configuration
#*****************************************************************

# Transaction timeout (30 seconds for clinical queries)
dbms.transaction.timeout=30s

# Maximum concurrent transactions
dbms.transaction.concurrent.maximum=1000

# Transaction sampling configuration
dbms.transaction.sampling.percentage=5

#*****************************************************************
# Query Configuration
#*****************************************************************

# Enable query caching
cypher.query_cache_size=1000
dbms.query.cache.size=1000

# Query timeout for long-running queries
dbms.transaction.timeout=30s

# Limit result set size to prevent memory issues
dbms.memory.transaction.max_size=1g

#*****************************************************************
# Logging Configuration
#*****************************************************************

# Enable query logging (for performance monitoring)
dbms.logs.query.enabled=true

# Log slow queries (> 1 second)
dbms.logs.query.threshold=1s

# CRITICAL HIPAA COMPLIANCE: Disable parameter logging (may contain PHI)
dbms.logs.query.parameter_logging_enabled=false

# Log file sizes
dbms.logs.query.max_size=20m
dbms.logs.query.rotation.keep_number=10

# Debug log level
dbms.logs.default_level=INFO

#*****************************************************************
# Performance Tuning
#*****************************************************************

# Vector index optimization
db.index.vector.ephemeral_graph_enabled=true

# Checkpoint interval (10 minutes)
dbms.checkpoint.interval.time=10m
dbms.checkpoint.interval.tx=100000

# Store copy buffer size (for faster writes)
dbms.tx_state.memory_allocation=ON_HEAP

#*****************************************************************
# Clustering (for production high availability)
#*****************************************************************

# Uncomment for cluster deployment
# dbms.mode=CORE
# initial.dbms.default_database=neo4j
# dbms.cluster.discovery.endpoints=neo4j-core-1:5000,neo4j-core-2:5000,neo4j-core-3:5000

#*****************************************************************
# Plugin Configuration
#*****************************************************************

# APOC configuration
apoc.export.file.enabled=true
apoc.import.file.enabled=true
apoc.import.file.use_neo4j_config=true

# Allow UUID generation
dbms.security.procedures.unrestricted=apoc.create.uuid

#*****************************************************************
# Metrics and Monitoring
#*****************************************************************

# Enable metrics collection
metrics.enabled=true
metrics.graphite.enabled=false
metrics.prometheus.enabled=true
metrics.prometheus.endpoint=0.0.0.0:2004

# JMX monitoring
dbms.jvm.additional=-Dcom.sun.management.jmxremote
dbms.jvm.additional=-Dcom.sun.management.jmxremote.port=3637
dbms.jvm.additional=-Dcom.sun.management.jmxremote.authenticate=false
dbms.jvm.additional=-Dcom.sun.management.jmxremote.ssl=false

#*****************************************************************
# Backup Configuration
#*****************************************************************

# Online backup enabled
dbms.backup.enabled=true
dbms.backup.listen_address=0.0.0.0:6362

#*****************************************************************
# Database Locations
#*****************************************************************

# Data directory
dbms.directories.data=/data
dbms.directories.logs=/logs
dbms.directories.import=/import
dbms.directories.plugins=/plugins

#*****************************************************************
# Additional JVM Parameters
#*****************************************************************

# Garbage collection tuning for large heaps
dbms.jvm.additional=-XX:+UseG1GC
dbms.jvm.additional=-XX:+ExplicitGCInvokesConcurrent
dbms.jvm.additional=-XX:+UnlockExperimentalVMOptions
dbms.jvm.additional=-XX:+TrustFinalNonStaticFields
dbms.jvm.additional=-XX:+DisableExplicitGC

# Large pages for better memory performance
dbms.jvm.additional=-XX:+UseLargePages
dbms.jvm.additional=-XX:LargePageSizeInBytes=2m

# Performance monitoring
dbms.jvm.additional=-XX:+AlwaysPreTouch
dbms.jvm.additional=-XX:-OmitStackTraceInFastThrow
